# Replicação do SysVol (DC01 para DC02) via Rsync

Este documento detalha como configurar a sincronização automática da pasta `/var/lib/samba/sysvol` para garantir que as Políticas de Grupo (GPO) e Scripts de Login estejam disponíveis em ambos os servidores.

---

## Panorama Geral da Solução

* **Ferramenta**: `rsync` (sincronização de arquivos) sobre `ssh` (túnel seguro).
* **Direção**: Do **DC01** (Principal) para o **DC02** (Secundário).
* **Frequência**: A cada 5 minutos.
* **Segurança**: Utilizaremos chaves SSH para que o DC01 acesse o DC02 sem precisar digitar senha.
* **Atributos**: Usaremos flags especiais (`-XA`) para garantir que as permissões NTFS/ACLs do Windows sejam preservadas no Linux.

---

## Pré-requisitos

No **DC01** e no **DC02**, instale o Rsync:

```bash
apt install rsync -y
``` 

<br>

No servidor DC02, precisamos configurar o usuário `aluno` para usar os comandos `rsync` e `samba-tool` como administrador sem precisar de senha.

```bash
echo "aluno ALL=(ALL) NOPASSWD: /usr/bin/rsync, /usr/bin/samba-tool" > /etc/sudoers.d/aluno
``` 
>O usuário aluno pode rodar o comando rsync como root sem senha. É seguro pois limitamos apenas a este comando.
---

## Implementação Passo a Passo
  
### Gerar Chaves SSH no DC01

Precisamos permitir que o **DC01** entre no **DC02** como root sem pedir senha.

No terminal do **DC01** (como root):

```bash
# Gera a chave (pressione Enter em todas as perguntas para deixar padrão/sem senha)
ssh-keygen -t rsa -b 4096 -N '' -f ~/.ssh/id_rsa

# Envia a chave para o DC02
# Substitua pelo IP do seu DC02
ssh-copy-id -i ~/.ssh/id_rsa.pub aluno@192.168.100.201
``` 
>O sistema pedirá a senha do usuário `aluno` do DC02 uma única vez.

<br>

**Teste a conexão**: Ainda no **DC01**, digite: `ssh aluno@192.168.100.201`. Se entrar direto sem pedir senha, funcionou. Digite exit para voltar ao DC01.

---

## Rsync com Sudo Remoto

Agora o comando de replicação muda ligeiramente. Precisamos usar a opção `--rsync-path` para dizer ao servidor remoto: "Quando eu conectar aí como aluno, por favor, rode o rsync usando sudo".

Teste o comando manualmente no DC01:

```bash
rsync -XAavz --delete-after --rsync-path="sudo rsync" /var/lib/samba/sysvol/ aluno@192.168.100.201:/var/lib/samba/sysvol/
``` 
* `--rsync-path="sudo rsync"`: O segredo. Ele manda o DC02 elevar privilégios.
* `aluno@...`: Conecta via SSH com o usuário comum.

Se rodar sem pedir senha e sem erros de "Permission denied", está perfeito.

---

## Agendar no Cron (DC01)

Agora vamos colocar na automação.

No DC01, execute o comando abaixo para criar o arquivo `/etc/cron.d/sysvol` com o agendamento no Cron.

```bash
echo '*/5 * * * * root rsync -XAavz --delete-after --rsync-path="sudo rsync" /var/lib/samba/sysvol/ aluno@192.168.100.201:/var/lib/samba/sysvol/ && ssh aluno@192.168.100.201 "sudo samba-tool ntacl sysvolreset" > /var/log/sysvol-replication.log 2>&1' > /etc/cron.d/sysvol
```

---

## Testar o SysVol

Execute o comando abaixo no DC01 e no Dc02:

```bash
samba-tool ntacl sysvolcheck
```
---