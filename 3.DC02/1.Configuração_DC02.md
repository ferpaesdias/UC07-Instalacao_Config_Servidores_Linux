# Controlador de Dom√≠nio Secund√°rio (DC02)

Este documento detalha como configurar um servidor Debian limpo para ingressar no dom√≠nio `empresatech.example` como um Controlador de Dom√≠nio (DC) Adicional.

--- 

## Panorama Geral da Solu√ß√£o

* **Objetivo**: O DC02 ir√° replicar todo o banco de dados do Active Directory (usu√°rios, senhas, grupos, DNS) do DC01.
* **M√©todo**: Utilizaremos o modo de "Ingresso como Controlador de Dom√≠nio" do Samba 4.
* **Fluxo**: O DC02 aponta o DNS para o DC01 -> Ingressa no dom√≠nio -> Copia os dados -> Torna-se um servidor aut√¥nomo.

---

## üõë Pr√©-requisitos de Rede

O Controlador de Dom√≠nio Secund√°rio precisa de um IP fixo e um nome definido.

1. **Definir o Hostname:**

    ```bash
    hostnamectl set-hostname dc02
    ```
<br/>

2. **Configurar IP Est√°tico:**

    Edite o arquivo `/etc/network/interfaces`:

    ```bash
    vim /etc/network/interfaces
    ```
    <br/>

    O arquivo deve conter a configura√ß√£o da interface LAN (ajuste o nome `enp0s3` conforme seu comando `ip link`):

    ```conf
    auto lo
    iface lo inet loopback

    allow-hotplug enp0s3
    iface enp0s3 inet static
        address 192.168.100.201/24
        gateway 192.168.100.1
    ```

    *Salve e saia.*

    <br/>

3. **Configurar DNS:**

    Edite o `/etc/resolv.conf`:

    ```bash
    vim /etc/resolv.conf
    ```

    <br/>

    Altere o conte√∫do para apontar para o DC01:

    ```conf
    search empresatech.example
    nameserver 192.168.100.200
    ```
    <br/>

2. **Aplicar Rede e Atualizar Hosts:**

    ```bash
    systemctl restart networking
    ```
    <br/>

    Edite o `/etc/hosts` para associar o nome ao IP. 
      
    ```bash
    vim /etc/hosts
    ```
    <br/>
    
    Apague tudo e adicione o conte√∫do abaixo:  
    ```conf
    127.0.0.1       localhost
    192.168.100.201 dc02.empresatech.example dc02
    ```
    <br/>

---

## üï∞Ô∏è Passo 1: Sincroniza√ß√£o de Tempo (Chrony)

O protocolo de seguran√ßa do Windows (Kerberos) falha se houver uma diferen√ßa de hor√°rio maior que 5 minutos entre o servidor e os clientes. O DC ser√° a fonte de hora oficial da rede.

1.  Instale o Chrony:
   
    ```bash
    apt update
    apt install chrony -y
    ```
    <br/>

2.  Edite `/etc/chrony/chrony.conf`:
    ```bash
    vim /etc/chrony/chrony.conf
    ```
    <br/>
    
    Comente a linha `pool 2.debian.pool.ntp.org iburst` e, abaixo dela, adicione os servidores do [NTP.br](ntp.br). Ficar√° assim:

    ```bash
    # Use Debian vendor zone.
    #pool 2.debian.pool.ntp.org iburst
    server a.ntp.br iburst
    server b.ntp.br iburst
    server c.ntp.br iburst

    ```
    <br/>
    
    Adicione a linha de permiss√£o no final do arquivo:
    ```conf
    # Permitir acesso NTP √† rede local
    allow 192.168.100.0/24
    ```
    <br/>

3.  Habilite e reinicie o servi√ßo:
    ```bash
    systemctl enable chrony
    systemctl restart chrony
    ```

    <br/>

4.  Teste o Chrony com o comando abaixo:
    
    ```bash
    chronyc sources
    ```
     <br>

    A sa√≠da do comando deve ser semelhante a abaixo:

    ```bash
    MS Name/IP address         Stratum Poll Reach LastRx Last sample               
    ===============================================================================
    ^* a.ntp.br                      2   6    37    14    -56us[ -227us] +/-   11ms
    ^- b.ntp.br                      2   6    37    14  +1596us[+1596us] +/-   55ms
    ^- c.ntp.br                      2   6    37    16  -1204us[-1375us] +/-   39ms
    ```
---


## üì¶ Passo 2: Instala√ß√£o do Samba AD DC

Vamos instalar os pacotes necess√°rios para o Samba funcionar como um substituto do Windows Server.

```bash
apt install samba smbclient krb5-user winbind libnss-winbind libpam-winbind -y
```
Durante a instala√ß√£o pode ser solicitados alguns dados, responda conforme est√° abaixo:

- **Realm Kerberos vers√£o 5 padr√£o**: `EMPRESATECH.EXAMPLE`
---

## ‚öôÔ∏è Passo 3: Preparar o Ambiente

Agora vamos configurar o preparar o ambiente.

**Limpar configura√ß√µes padr√£o**: O servi√ßo padr√£o do Samba para arquivos (smbd) conflita com o servi√ßo de Dom√≠nio (samba-ad-dc). Vamos desativar os antigos e limpar a configura√ß√£o.

```bash
systemctl stop smbd nmbd winbind
systemctl disable smbd nmbd winbind
mv /etc/samba/smb.conf /etc/samba/smb.conf.backup
```
<br>

Crie um backup do arquivo `/etc/krb5.conf`:

```bash
mv /etc/krb5.conf /etc/krb5.conf.backup
```
<br>

Edite o arquivo

```bash
vim /etc/krb5.conf
```
<br>

Apague todo o conte√∫do e adicione a configura√ß√£o abaixo:

```conf
[libdefaults]
	default_realm = EMPRESATECH.EXAMPLE
	dns_lookup_realm = false
	dns_lookup_kdc = true
```
<br>

Agora, edite o arquivo `/etc/samba/smb.conf `:

```bash
vim /etc/samba/smb.conf 
```
<br>

Na se√ß√£o `[global]`, abaixo da linha `workgroup = EMPRESATECH`, adicione a configura√ß√£o `dns forwarder = 8.8.8.8`. Deve ficar igual est√° abaixo:

```bash
# Global parameters
[global]
	netbios name = DC02
	realm = EMPRESATECH.EXAMPLE
	server role = active directory domain controller
	workgroup = EMPRESATECH
	dns forwarder = 8.8.8.8	

[sysvol]
	path = /var/lib/samba/sysvol
	read only = No

[netlogon]
	path = /var/lib/samba/sysvol/empresatech.example/scripts
	read only = No
```

---

## üîÑ Passo 4: Ingressar como DC (Join)

Este √© o comando principal que transforma o servidor em um Controlador de Dom√≠nio Secund√°rio.

```bash
samba-tool domain join empresatech.example DC -U "EMPRESATECH\administrator" --dns-backend=SAMBA_INTERNAL
```
>O sistema pedir√° a senha do Administrator do dom√≠nio. Digite e aguarde a mensagem "Joined domain empresatech.example".

---

## ‚úÖ Passo 5: Ativar o Servi√ßo

Agora vamos iniciar o Active Directory no DC02.

```bash
# Desmascara o servi√ßo (caso esteja oculto)
systemctl unmask samba-ad-dc

# Habilita para iniciar no boot
systemctl enable samba-ad-dc

# Inicia o servi√ßo agora
systemctl start samba-ad-dc
```
---

## üõ†Ô∏è Passo 6: Ajustar DNS P√≥s-Instala√ß√£o

Agora que o DC02 √© um servidor funcional, ele deve apontar para si mesmo (para agilidade) e para o DC01 (para redund√¢ncia).

```bash
vim /etc/resolv.conf
```
<br>

Atualize para:

```bash
search empresatech.example
nameserver 127.0.0.1
nameserver 192.168.100.200
```
---

## üîç Passo 7: Verifica√ß√£o da Replica√ß√£o

Para ter certeza de que o DC01 e DC02 est√£o conversando e trocando dados de usu√°rios, execute este comando no DC02:

```bash
samba-tool drs showrepl
```
O que procurar na sa√≠da: Voc√™ ver√° v√°rias se√ß√µes (Schema, Configuration, DomainDnsZones). Procure pela frase: `Last attempt @ [Data] was successful`.

Se todas as tentativas estiverem como `successful`, o seu DC02 est√° operacional e sincronizado.

---