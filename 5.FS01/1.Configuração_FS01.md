# Servidor de Arquivos (FS01)

Este guia cobre a configura√ß√£o de um servidor de arquivos robusto integrado ao Active Directory. Utilizaremos o Samba no modo **Domain Member**.

**Objetivo:** Criar pastas compartilhadas onde apenas os departamentos corretos tenham acesso (Ex: O pessoal de TI n√£o pode ler a folha de pagamento do RH).

**Informa√ß√µes do Servidor:**
* **Hostname:** `fs01`
* **IP:** `192.168.100.203`
* **Fun√ß√£o:** File Server Member

---

## üõë Pr√©-requisitos (Rede e Rel√≥gio)

Para entrar no dom√≠nio, este servidor precisa encontrar o DC e estar na mesma hora que ele.


1. **Definir o Hostname:**

    ```bash
    hostnamectl set-hostname fs01
    ```
<br/>

2. **Configurar IP Est√°tico:**

    Edite o arquivo `/etc/network/interfaces`:

    ```bash
    vim /etc/network/interfaces
    ```
    <br/>

    O arquivo deve conter a configura√ß√£o da interface LAN (ajuste o nome `enp0s3` conforme seu comando `ip link`):

    ```conf
    auto lo
    iface lo inet loopback

    allow-hotplug enp0s3
    iface enp0s3 inet static
        address 192.168.100.203/24
        gateway 192.168.100.1
    ```

    *Salve e saia.*

<br/>

3. **Configurar DNS Tempor√°rio (Para Instala√ß√£o):**

    Para baixar os pacotes, precisamos de internet. Edite o `/etc/resolv.conf`:

    ```bash
    vim /etc/resolv.conf
    ```

    <br/>

    Adicione um DNS p√∫blico temporariamente:

    ```conf
    search empresatech.example
    nameserver 192.168.100.200
    nameserver 192.168.100.201
    ```
    <br/>

4. **Aplicar Rede e Atualizar Hosts:**

    ```bash
    systemctl restart networking
    ```
    <br/>

    Edite o `/etc/hosts` para associar o nome ao IP. 
      
    ```bash
    vim /etc/hosts
    ```
    <br/>
    
    Apague tudo e adicione o conte√∫do abaixo:  
    ```conf
    127.0.0.1       localhost
    192.168.100.203 fs01.empresatech.example fs01
    ```
    <br/>

---

## üï∞Ô∏è Sincroniza√ß√£o de Tempo (Chrony)

O protocolo de seguran√ßa do Windows (Kerberos) falha se houver uma diferen√ßa de hor√°rio maior que 5 minutos entre o servidor e os clientes. O DC ser√° a fonte de hora oficial da rede.

1.  Instale o Chrony:
   
    ```bash
    apt update
    apt install chrony -y
    ```
    <br/>

2.  Edite `/etc/chrony/chrony.conf`:
    ```bash
    vim /etc/chrony/chrony.conf
    ```
    <br/>
    
    Comente a linha `pool 2.debian.pool.ntp.org iburst` e, abaixo dela, adicione os servidores do [NTP.br](ntp.br). Ficar√° assim:

    ```bash
    # Use Debian vendor zone.
    #pool 2.debian.pool.ntp.org iburst
    server 192.168.100.200 iburst
    server 192.168.100.201 iburst
    ```
    <br/>
    
3.  Habilite e reinicie o servi√ßo:
    ```bash
    systemctl enable chrony
    systemctl restart chrony
    ```

    <br/>

4.  Teste o Chrony com o comando abaixo:
    
    ```bash
    chronyc sources
    ```
     <br>

    A sa√≠da do comando deve ser semelhante a abaixo:

    ```bash
    MS Name/IP address         Stratum Poll Reach LastRx Last sample               
    ===============================================================================
    MS Name/IP address         Stratum Poll Reach LastRx Last sample               
    ===============================================================================
    ^* 192.168.100.200               3   6   177     2   +756us[ +904us] +/-   11ms
    ^+ 192.168.100.201               3   6   177     2   +161us[ +161us] +/-   10ms
    ```
---

## üì¶ Passo 1: Instala√ß√£o e Prepara√ß√£o

Vamos instalar o Samba e o **Winbind**. O Winbind √© o "tradutor" que permite ao Linux entender usu√°rios do Windows/AD.

```bash
apt install samba krb5-config winbind libpam-winbind libnss-winbind -y
```

Durante a instala√ß√£o pode ser solicitados alguns dados, responda conforme est√° abaixo:

- **Realm Kerberos vers√£o 5 padr√£o**: `EMPRESATECH.EXAMPLE`
- **Servidores Kerberos para seu realm**: `dc01.empresatech.example`
- **Servidor administrativo para seu realm Kerberos**: `dc01.empresatech.example`

---

## ü§ù Passo 2: Ingressar no Dom√≠nio (Domain Join)

Diferente do DC01 (que cria o dom√≠nio), o FS01 precisa pedir permiss√£o para entrar nele.

1. Configurar o Samba (`smb.conf`): Apague o original e crie um novo focado em ser membro.

    ```bash
    mv /etc/samba/smb.conf /etc/samba/smb.conf.backup
    vim /etc/samba/smb.conf
    ```

    <br/>

    Cole este conte√∫do:

    ```bash
    [global]
       workgroup = EMPRESATECH
       security = ads
       realm = EMPRESATECH.EXAMPLE
    
       # Logs para facilitar depura√ß√£o
       log file = /var/log/samba/%m.log
       log level = 1
    
       # Configura√ß√£o do Winbind (O Tradutor de IDs)
       # Mapeia usu√°rios do AD para IDs do Linux automaticamente
       idmap config * : backend = tdb
       idmap config * : range = 3000-7999
    
       idmap config EMPRESATECH : backend = rid
       idmap config EMPRESATECH : range = 10000-999999
    
       template shell = /bin/bash
       template homedir = /home/%U
       winbind use default domain = yes
       winbind offline logon = yes
    
       # Desabilitar suporte a impressoras (opcional, economiza recursos)
       load printers = no
       printing = bsd
       printcap name = /dev/null
       disable spoolss = yes
    ```

<br/>

2. Ingressar no AD: Execute o comando para entrar no dom√≠nio usando a conta de administrador.

    ```bash
    net ads join -U Administrator
    ```
    >Digite a senha `SenhaForte123!`.
    
    <br/>
    
    Se tiver sucesso, voc√™ ver√° a mensagem:
    
    ```bash
    Joined 'FS01' to dns domain 'empresatech.example'
    ```

    <br/>

3. Configurar o Sistema para ver os Usu√°rios: Precisamos dizer ao Debian: "Quando procurar um usu√°rio, olhe no sistema local e TAMB√âM no Winbind".   

    <br/>
    
    Edite /etc/nsswitch.conf:
    
    ```bash
    vim /etc/nsswitch.conf
    ```
    
    <br/>
    
    Procure as linhas `passwd` e `group` e, se n√£o tiver, adicione `winbind` no final delas, ficar√° assim:
    
    ```bash
    passwd:         files systemd winbind
    group:          files systemd winbind
    ```
    
    <br/>
    
4. Reiniciar servi√ßos:

    ```bash
    systemctl restart smbd nmbd winbind
    ```
    
    <br/>
    
5. Teste de Conex√£o: Verifique se o servidor consegue "ver" os usu√°rios do AD.

    ```bash
    wbinfo -u
    ```
    
    <br/>
    
    Se tiver sucesso, voc√™ ver√° a lista de nomes dos usu√°rios, por exemplo:
    
    ```bash
    fabio.costa
    julia.pereira
    guest
    bruno.alves
    krbtgt
    daniel.rocha
    helena.silva
    elisa.martins
    ana.souza
    gabriel.lima
    carla.dias
    administrator
    igor.santos
    ```
    
    <br/>
    
    ```bash
    wbinfo -g
    ```
    
    <br/>
    
    Se tiver sucesso, voc√™ ver√° a lista dos grupos, por exemplo:
    
    ```bash
    denied rodc password replication group
    grp_financeiro
    grp_rh
    grp_ti
    domain admins
    enterprise read-only domain controllers
    domain guests
    ras and ias servers
    schema admins
    domain users
    allowed rodc password replication group
    dnsadmins
    cert publishers
    dnsupdateproxy
    enterprise admins
    protected users
    read-only domain controllers
    domain controllers
    group policy creator owners
    domain computers
    ```

---

## üìÇ Passo 3: Cria√ß√£o das Pastas e Permiss√µes

Vamos criar a estrutura de diret√≥rios e definir quem pode acessar o qu√™.

1. Criar a estrutura:

    ```bash
    mkdir -p /srv/samba/financeiro
    mkdir -p /srv/samba/rh
    mkdir -p /srv/samba/ti
    mkdir -p /srv/samba/publico
    ```

    <br/>

2. **Configurar permiss√µes no n√≠vel do Sistema (Linux)**: Por seguran√ßa, vamos dizer que o "dono" dessas pastas √© o `root`, mas vamos abrir permiss√£o total (777) no n√≠vel do disco, e controlar o acesso real no arquivo de configura√ß√£o do Samba (mais f√°cil de gerenciar).

    ```bash
    chmod 777 /srv/samba/*
    ```
---

## üìÇ Passo 4: Configurando os Compartilhamentos

Agora vamos editar o smb.conf novamente para expor essas pastas na rede, aplicando as restri√ß√µes de seguran√ßa por grupo.

1. Edite `/etc/samba/smb.conf` e adicione ao final do arquivo:

    ```bash
    # --- Compartilhamentos Departamentais ---

    [Financeiro]
        path = /srv/samba/financeiro
        read only = no
        browsable = yes
        # Apenas o grupo financeiro acessa
        valid users = @grp_financeiro
        # Cria arquivos com permiss√£o de escrita para o grupo
        create mask = 0770
        directory mask = 0770

    [RecursosHumanos]
        path = /srv/samba/rh
        read only = no
        browsable = yes
        valid users = @grp_rh
        create mask = 0770
        directory mask = 0770

    [Tecnologia]
        path = /srv/samba/ti
        read only = no
        browsable = yes
        valid users = @grp_ti
        create mask = 0770
        directory mask = 0770

    [Publico]
        path = /srv/samba/publico
        read only = no
        browsable = yes
        # Todos os usu√°rios do dom√≠nio podem acessar
        valid users = @"Domain Users"
    ```

     <br/>

2. Aplicar altera√ß√µes:

    ```bash
    smbcontrol all reload-config
    ```
---
