# Controlador de Dom√≠nio Prim√°rio (DC01)

Este guia cobre a instala√ß√£o e configura√ß√£o do **Samba 4** atuando como um Controlador de Dom√≠nio Active Directory (AD DC).

**Objetivo:** Centralizar a autentica√ß√£o de usu√°rios, fornecer resolu√ß√£o de nomes (DNS) e garantir a sincroniza√ß√£o de hor√°rio (NTP) para toda a rede.

**Informa√ß√µes do Servidor:**

* **Hostname:** `dc01`
* **IP:** `192.168.100.200`
* **Dom√≠nio:** `empresatech.example`
* **Reino (Realm):** `EMPRESATECH.EXAMPLE`
* **Senha de Admin:** `SenhaForte123!` (Did√°tica)

---

## üõë Pr√©-requisitos de Rede

O Controlador de Dom√≠nio √© o servidor mais importante da rede. Ele precisa de um IP fixo e um nome definido.

1. **Definir o Hostname:**

    ```bash
    hostnamectl set-hostname dc01
    ```
<br/>

2. **Configurar IP Est√°tico:**

    Edite o arquivo `/etc/network/interfaces`:

    ```bash
    vim /etc/network/interfaces
    ```
    <br/>

    O arquivo deve conter a configura√ß√£o da interface LAN (ajuste o nome `enp0s3` conforme seu comando `ip link`):

    ```conf
    auto lo
    iface lo inet loopback

    allow-hotplug enp0s3
    iface enp0s3 inet static
        address 192.168.100.200/24
        gateway 192.168.100.1
    ```

    *Salve e saia.*

<br/>

3. **Configurar DNS Tempor√°rio (Para Instala√ß√£o):**

    Para baixar os pacotes, precisamos de internet. Edite o `/etc/resolv.conf`:

    ```bash
    vim /etc/resolv.conf
    ```

    <br/>

    Adicione um DNS p√∫blico temporariamente:

    ```conf
    nameserver 8.8.8.8
    ```
    <br/>

4. **Aplicar Rede e Atualizar Hosts:**

    ```bash
    systemctl restart networking
    ```
    <br/>

    Edite o `/etc/hosts` para associar o nome ao IP. 
      
    ```bash
    vim /etc/hosts
    ```
    <br/>
    
    Apague tudo e adicione o conte√∫do abaixo:  
    ```conf
    127.0.0.1       localhost
    192.168.100.200 dc01.empresatech.example dc01
    ```
    <br/>

---

## üï∞Ô∏è Passo 1: Sincroniza√ß√£o de Tempo (Chrony)

O protocolo de seguran√ßa do Windows (Kerberos) falha se houver uma diferen√ßa de hor√°rio maior que 5 minutos entre o servidor e os clientes. O DC ser√° a fonte de hora oficial da rede.

1.  Instale o Chrony:
   
    ```bash
    apt update
    apt install chrony -y
    ```
    <br/>

2.  Configure para permitir que a rede LAN consulte a hora aqui. Edite `/etc/chrony/chrony.conf`:
    ```bash
    vim /etc/chrony/chrony.conf
    ```
    <br/>
    
    Adicione a linha de permiss√£o no final do arquivo:
    ```conf
    # Permitir acesso NTP √† rede local
    allow 192.168.100.0/24
    ```
    <br/>

3.  Habilite e reinicie o servi√ßo:
    ```bash
    systemctl enable chrony
    systemctl restart chrony
    ```

---

## üì¶ Passo 2: Instala√ß√£o do Samba AD DC

Vamos instalar os pacotes necess√°rios para o Samba funcionar como um substituto do Windows Server.

```bash
apt install samba smbclient krb5-config winbind libpam-winbind libnss-winbind -y
```
Durante a instala√ß√£o pode ser solicitados alguns dados, responda conforme est√° abaixo:

- **Realm Kerberos vers√£o 5 padr√£o**: `EMPRESATECH.EXAMPLE`
- **Servidores Kerberos para seu realm**: `dc01.empresatech.example`
- **Servidor administrativo para seu realm Kerberos**: `dc01.empresatech.example`

---

## ‚öôÔ∏è Passo 3: Provisionamento do Dom√≠nio

Agora vamos configurar o "c√©rebro" da rede.

1. **Limpar configura√ß√µes padr√£o**: O servi√ßo padr√£o do Samba para arquivos (smbd) conflita com o servi√ßo de Dom√≠nio (samba-ad-dc). Vamos desativar os antigos e limpar a configura√ß√£o.

    ```bash
    systemctl stop smbd nmbd winbind
    systemctl disable smbd nmbd winbind
    systemctl unmask samba-ad-dc
    mv /etc/samba/smb.conf /etc/samba/smb.conf.backup
    ```

<br/>

2. **Criar o Dom√≠nio**: Execute o comando interativo para criar a estrutura do AD:

    ```bash
    samba-tool domain provision \
      --use-rfc2307 \
      --realm=EMPRESATECH.EXAMPLE \
      --domain=EMPRESATECH \
      --server-role=dc \
      --dns-backend=SAMBA_INTERNAL \
      --adminpass='SenhaForte123!'
    ```

<br/>

3. **Configurar Autentica√ß√£o Local (Kerberos)**: Substitua o arquivo de configura√ß√£o do sistema pelo gerado pelo Samba:

    ```bash
    mv /etc/krb5.conf /etc/krb5.conf.orig
    cp /var/lib/samba/private/krb5.conf /etc/krb5.conf
    ```

---

## üîÑ Passo 4: Configura√ß√£o Final de DNS e Servi√ßo

Agora que o dom√≠nio existe, o servidor deve consultar a si mesmo (localhost) para resolver nomes da rede interna, n√£o mais o Google.

1. Ajuste Definitivo do `/etc/resolv.conf`:

    ```bash
    vim /etc/resolv.conf
    ```

    <br/>

    Altere o conte√∫do para:

    ```bash
    search empresatech.example
    nameserver 127.0.0.1
    ```
    
    <br/>

    **Explica√ß√£o**:

    `search`: Permite usar nomes curtos (ex: pingar `pc01` em vez de `pc01.empresatech.example`).
    `nameserver 127.0.0.1`: Diz ao Linux para perguntar ao Samba local sobre endere√ßos IP.

<br/>

2. Iniciar o Dom√≠nio:

    ```bash
    systemctl enable samba-ad-dc
    systemctl start samba-ad-dc
    ```

---

## ‚úÖ Passo 5: Testes de Valida√ß√£o

Verifique se o dom√≠nio est√° saud√°vel antes de prosseguir.

<br/>

1. **Validar DNS (SRV Records)**: Verifica se os servi√ßos LDAP est√£o registrados no DNS.
   
    ```bash
    host -t SRV _ldap._tcp.empresatech.example
    ```
   >Sa√≠da esperada: `_ldap._tcp.empresatech.example has SRV record 0 100 389 dc01.empresatech.example.`

    <br/>

2. Testar Login de Administrador:

    ```bash
    smbclient -L localhost -U Administrator
    ```
   >Digite a senha `SenhaForte123!` quando solicitado.

---
