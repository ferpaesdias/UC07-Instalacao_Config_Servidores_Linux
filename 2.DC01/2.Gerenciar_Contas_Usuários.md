# Gerenciar contas de usu치rios

Este guia mostra como criar usu치rios e grupos de usu치rios da **EmpresaTech** no dom칤nio `empresatech.example`. 

--- 

## Cria칞칚o da Estrutura da Empresa

Vamos criar os grupos e usu치rios conforme o organograma da **EmpresaTech**.

<br>

## 游논 Estrutura de Usu치rios e Grupos

Neste laborat칩rio, vamos gerenciar a autentica칞칚o centralizada. Estes s칚o os funcion치rios da nossa empresa fict칤cia:

1. Departamento Financeiro (`Financeiro`)

   * Ana Souza (`ana.souza`)
   * Bruno Alves (`bruno.alves`)
   * Carla Dias (`carla.dias`)
   * Julia Pereira (`julia.pereira`)

   <br>

2. Recursos Humanos (`RH`)

   * Daniel Rocha (`daniel.rocha`)
   * Elisa Martins (`elisa.martins`)
   * Fabio Costa (`fabio.costa`)
   * Igor Santos (`igor.santos`)

   <br>

3. Tecnologia / TI (`TI`)

   * Gabriel Lima (`gabriel.lima`)
   * Helena Silva (`helena.silva`)

   <br>

4. Diretoria (`Diretoria`)

   * Luis Divino (`luis.divino`)
---


### Criar Grupos

#### Criar um grupo 

O comando abaixo cria um 칰nico grupo

```bash
samba-tool group add "nome_grupo" --description="descricao"
```
* `samba-tool group add`: 칄 o comando do Samba4 para adicionar grupos.
* `--description=`: Descri칞칚o do grupo.
<br>

#### Criar grupos em massa

Segue abaixo como criar v치rios grupos ao mesmo tempo.

1. Preparar o Arquivo de Entrada (CSV)
Primeiro, precisamos de uma lista. Vamos criar um arquivo simples onde cada linha cont칠m o **Nome do Grupo** e uma **Descri칞칚o**, separados por um ponto e v칤rgula `;`.
 
   ```bash
   vim lista_grupos.csv
   ```

   <br>
   
   Cole o conte칰do abaixo (exemplo):

   ```csv
   Financeiro;Grupo do Departamento Financeiro
   RH;Recursos Humanos e Departamento Pessoal
   TI;Tecnologia da Informa칞칚o
   Diretoria;Grupo dos diretores da empresa
   ```
<br>

2. O Script de Automa칞칚o

   Agora vamos criar o script que l칡 essa lista e executa o comando.
   
   Crie o arquivo do script:

   ```bash
   vim criar_grupos.sh
   ```

   <br>
   
   Cole o seguinte c칩digo:

   ```txt
   #!/bin/bash
   
   # =======================================================
   # SCRIPT: CRIAR GRUPOS EM MASSA NO SAMBA4 AD
   # =======================================================
   
   # 1. Defini칞칚o do arquivo de entrada
   ARQUIVO_LISTA="lista_grupos.csv"
   
   # Verifica se o arquivo existe
   if [ ! -f "$ARQUIVO_LISTA" ]; then
       echo "Erro: O arquivo $ARQUIVO_LISTA n칚o foi encontrado."
       exit 1
   fi
   
   echo "--- Iniciando a cria칞칚o de grupos no AD ---"
   
   # 2. Leitura do arquivo linha por linha
   # IFS=';' define que o ponto e v칤rgula separa as variaveis
   while IFS=';' read -r nome_grupo descricao || [ -n "$nome_grupo" ]; do
       
       # Ignora linhas vazias
       if [ -z "$nome_grupo" ]; then
           continue
       fi
   
       # 3. Executa o comando samba-tool
       # --description adiciona a descri칞칚o no AD
       echo "Criando grupo: $nome_grupo..."
       
       samba-tool group add "$nome_grupo" --description="$descricao"
       
       # Verifica se deu certo (0 = sucesso)
       if [ $? -eq 0 ]; then
           echo "OK: Grupo '$nome_grupo' criado com sucesso."
       else
           echo "AVISO: Falha ao criar '$nome_grupo' (Talvez j치 exista?)"
       fi
       echo "-------------------------------------------"
   
   done < "$ARQUIVO_LISTA"
   
   echo "Importa칞칚o finalizada."
   ```
   * `IFS=';'`: (Internal Field Separator) Diz ao comando `read` que, quando encontrar um ponto e v칤rgula na linha, ele deve separar o texto. A primeira parte vai para a vari치vel `$nome_grupo` e a segunda para `$descricao`.
   * `|| [ -n "$nome_grupo" ]`: Um truque para garantir que o script leia at칠 a 칰ltima linha do arquivo de texto, mesmo que ela n칚o termine com uma quebra de linha (Enter).

   <br>

3. Executando o Script

   Agora vamos dar permiss칚o de execu칞칚o ao script:
   
   ```bash
   chmod +x criar_grupos.sh
   ```

   <br>
   
   Execute o script:

   ```bash
   bash criar_grupos.sh
   ```
   <br>

4. Liste os grupos

   Liste os grupos para verificar ser foram criados corretamente:

   ```bash
   samba-tool group list
   ```
   <br>

5. Delete um grupo

   ```bash
   samba-tool delete nome_grupo
   ```
---

### Criar Usu치rios

#### Criar um usu치rio 

O comando abaixo cria um 칰nico grupo

```bash
samba-tool user create "nome.usuario" "SenhaForte123!" --must-change-at-next-login --use-username-as-cn
```
* `samba-tool user create`: 칄 o comando do Samba4 para adicionar usu치rios.
* `--must-change-at-next-login`: Obriga o usu치rio alterar a senha no primeiro login.
* `--use-username-as-cn`: Garante que o "Nome de Exibi칞칚o" no AD seja igual ao login, evitando erros se voc칡 n칚o forneceu Nome e Sobrenome separados.

<br>

Adicione o usu치rio criado a um dos grupos adicionados anteriormente.

```bash
samba-tool group addmembers "nome_grupo" "nome.usuario" 
```

<br>

#### Criar usu치rios em massa

Segue abaixo como criar v치rios usuarios e adicion치-los ao seu grupo ao mesmo tempo.

>Consideramos que os grupos j치 foram criados.

<br>

1. Preparar o Arquivo de Entrada (CSV)
Primeiro, precisamos de uma lista. Vamos criar um arquivo simples onde cada linha cont칠m o **Nome do Grupo** e uma **Descri칞칚o**, separados por um ponto e v칤rgula `;`.
 
   ```bash
   vim lista_usuarios.csv
   ```

   <br>
   
   Cole o conte칰do abaixo (exemplo):

   ```csv
   ana.souza;Mudar123!;Financeiro
   bruno.alves;Mudar123!;Financeiro
   carla.dias;Mudar123!;Financeiro
   julia.pereira;Mudar123!;Financeiro
   daniel.rocha;Mudar123!;RH
   elisa.martins;Mudar123!;RH
   fabio.costa;Mudar123!;RH
   igor.santos;Mudar123!;RH
   gabriel.lima;Mudar123!;TI
   helena.silva;Mudar123!;TI
   luis.divino;Mudar123!;Diretoria
   ```
   <br>


2. O Script de Automa칞칚o
   
   Crie o arquivo do script:

   ```bash
   vim criar_usuarios.sh
   ```

   <br>
   
   Cole o seguinte c칩digo:

   ```bash
   #!/bin/bash

   # =======================================================
   # SCRIPT: CRIAR USU츼RIOS E ADICIONAR A GRUPOS (SAMBA4)
   # Autor: Parceiro de Programacao
   # =======================================================

   ARQUIVO_CSV="lista_usuarios.csv"
   
   # Verifica se o arquivo existe
   if [ ! -f "$ARQUIVO_CSV" ]; then
       echo "Erro: O arquivo $ARQUIVO_CSV n칚o foi encontrado."
       exit 1
   fi
   
   echo "--- Iniciando Importa칞칚o de Usu치rios ---"
   
   # L칡 o arquivo linha por linha
   # IFS=';' separa os campos pelo ponto e v칤rgula
   while IFS=';' read -r usuario senha grupo || [ -n "$usuario" ]; do
   
       # Pula linhas vazias
       if [ -z "$usuario" ]; then
           continue
       fi
   
       echo "Processando: $usuario..."
   
       # 1. Cria o usu치rio
       # --must-change-at-next-login: For칞a a troca de senha
       # --use-username-as-cn: Usa o nome de usu치rio como Nome Comum
       samba-tool user create "$usuario" "$senha" \
           --must-change-at-next-login \
           --use-username-as-cn
   
       # Verifica se a cria칞칚o funcionou (c칩digo 0)
       if [ $? -eq 0 ]; then
           echo " > Usu치rio '$usuario' criado com sucesso."
           
           # 2. Adiciona ao Grupo
           # S칩 tenta adicionar se o grupo foi informado na planilha
           if [ -n "$grupo" ]; then
               samba-tool group addmembers "$grupo" "$usuario"
               
               if [ $? -eq 0 ]; then
                    echo " > Adicionado ao grupo '$grupo'."
               else
                    echo " ! AVISO: Falha ao adicionar ao grupo '$grupo'. O grupo existe?"
               fi
           fi
       else
           echo " ! ERRO: Falha ao criar usu치rio '$usuario'. (Talvez j치 exista?)"
       fi
       
       echo "-------------------------------------------"
   
   done < "$ARQUIVO_CSV"
   
   echo "Importa칞칚o finalizada."
   ```

   <br>

3. Executando o Script

   Agora vamos dar permiss칚o de execu칞칚o ao script:
   
   ```bash
   chmod +x criar_usuarios.sh
   ```

   <br>
   
   Execute o script:

   ```bash
   bash criar_usuarios.sh
   ```
   <br>

4. Liste os usu치rios

   Liste os usu치rios para verificar ser foram criados corretamente:

   ```bash
   samba-tool user list
   ```
   <br>

5. Delete um usu치rio

   ```bash
   samba-tool user delete nome.usuario
   ```
---
